---
layout:     post
title:      《计算机网络》梳理
subtitle:  	详解HTTP、HTTP协议以及HTTPS握手过程
date:       2022-05-22
author:    	bolero
header-img: img/post-bg-github-cup.jpg
catalog: 	true
tags:
    - 计算机网络
    - HTTPS协议
---

> 我们都知道HTTPS协议比HTTP更安全，那么为什么HTTPS协议比HTTP更安全呢？HTTP和HTTPS区别在哪呢？一次安全可靠的通信又包含些什么呢？本文将从细节开始讲起
>
> 本篇文章包含以下内容：
>
> - HTTP
> - TCP
> - 三次握手四次挥手
> - HTTPS
> - HTTPS握手和数据传输

### 预备知识

#### HTTP

- 超文本传输协议，是一种**通信协议**；允许超文本标记文档从`Web`服务器传送到客户端的浏览器中
- `http`是**无状态协议**，HTTP协议无法根据之前的状态进行本次的请求处理, 这保证了它的高效。`Cookie`和`Section`的出现使`http`在保持高效的情况下，能够记住状态
- `http`是**无连接**：无连接的含义是限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接

#### TCP

- 传输控制协议, 是一种面向连接的、安全可靠的传输层通信协议

**TCP报文结构**

<img src="https://s2.loli.net/2022/05/22/7n1tpVQxic2szY4.png" alt="tcpconnection.png" style="zoom:80%;" />

其中我们需要了解一些重要概念：

- 源端口和目的端口： 各占两个字节（16位），是传输层与应用层的服务接口，以实现复用和分用
- 序号(sequence number): 占4个字节, 只本报文段所发送的数据的第一个字节的序号
- 确认序号(acknowledgement number): 占4个字节，是期望收到对方下一个报文段的第一个字节的序号(即收到对方的报文段最后一个字节的序号加一)

- 标志位(flag): 
  - 确认（ACK）：ACK=1时确认号字段（acknowledgement number）才有效；
  - 同步（SYN）：SYN=1表示这是一个“连接请求（SYN）”或“连接接受（SYN-ACK）”报文；
  - 终止（FIN）：用于释放连接，FIN=1表明报文段发送完毕，要求释放连接。

**面向流的TCP协议**

TCP对连续的字节流进行分段，形成TCP报文段，这和UDP的"给多少装多少正相反"。

- TCP vs UDP

  - UDP

    - 是一个简单的协议，面向**数据**报通信
    - 工作在IP层之上的传输层协议，利用ip提供面向无连接的通信服务
    - 不合并，不拆分，无论应用层交给UDP多长的报文，它统一发送
    - 输过程中如果丢包，不负责重发，包的顺序出现乱序，不负责纠正
    - 即便出现网络堵塞，也无法进行流量控制，无法避免网络堵塞

  - TCP和UDP的区别

    - tcp面向连接，udp无连接。在TCP协议进行网络通信时，需要先建立连接，也就是说需要先将客户端与服务器的连接连好，然后在进行数据交互
    - tcp可靠，udp不可靠。tcp有数据包校验， 防止发送过来的数据是错误数据；拥塞控制，保证数据在网络中传播的可靠性，降低丢包的概率，提高TCP的可靠性

    - tcp面向字节流的，UDP是面向数据报文的
    - TCP只支持点对点通信，UDP支持一对一，一对多，多对多
    - TCP有拥塞控制机制，UDP没有。TCP的拥塞控制可是保证了TCP协议在网络中传输的可靠性，降低重传和丢包的概率

#### TCP 连接的建立(三次握手)与释放(四次挥手)

为了保证能建立一个安全可靠的连接，TCP 建立连接的过程需要三次“握手”，也就是在连接的建立阶段，需要在客户和服务器之间交换三个TCP报文段

**第一次握手**

由客户端发起，客户端会向服务端发送一个报文：

- seq = x
- SYN = 1 表示发起新的连接

**第二次握手**

服务端收到后，向客户端发送一个确认消息包：

- SYN = 1
- ACK = 1 标志位为1，表示确认客户端发起的第一次连接请求
- seq = y
- ack = x + 1 表示收到客户端的序号seq并加1作为自己的确认值

此时客户端明确能给服务端成功发消息，也能成功收到服务端的响应

**第三次握手**

- ACK = 1 表示“确认收到服务器端同意连接的信号”
- seq = x + 1 表示收到服务器端的确认号ack，并将其值作为自己的序号值
- ack = y +1  表示收到服务器端序号seq, 并将其值加1作为自己的确认号ack的值

至此三次握手，客户端进入ESTABLISHED阶段。在客户端与服务器端传输的TCP报文中，双方的确认号Ack和序号Seq的值，都是在彼此Ack和Seq值的基础上进行计算的，这样做保证了TCP报文传输的连贯性。一旦出现某一方发出的TCP报文丢失，便无法继续"握手"，以此确保了"三次握手"的顺利完成

![threeHandshakes.png](https://s2.loli.net/2022/05/22/Dp8fLXbevdTNzEg.png)

****

连接完毕后，将进行TCP的释放，也就是所谓的四次挥手，与建立连接不同的是，如果某一方想要释放连接，另一方“不一定”就想跟着释放连接，因为它可能还有东西没传完

**第一次挥手**

客户端会发送一个报文：

- FIN = 1 标志位 1 表示“请求释放连接“
- seq = u 

**第二次挥手**

服务器接收到FIN明白客户端想要断开连接，向客户端发送一个确认包：

- ACK = 1 
- seq = u
- ack = u + 1 表示是在收到客户端报文的基础上，将其序号seq值加1作为本段报文确认号Ack的值

**第三次挥手**

服务器端做好了释放服务器端到客户端方向上的连接准备，继续发送一个断开连接的报文：

- FIN = 1
- ACK = 1
- seq = w
- ack = u + 1 表示是在收到客户端报文的基础上，将其序号seq值加1作为本段报文确认号ack的值

**第四次挥手**

客户端收到从服务器端发出的TCP报文，确认了服务器端已做好释放连接的准备。并向服务器端发送一段报文：

- ACK = 1 表示“接收到服务器准备好释放连接的信号”
- seq = u + 1
- ack = w + 1 表示是在收到了服务器端报文的基础上，将其序号seq值加一作为本段报文确认号的值

由此完成“四次挥手”。与“三次挥手”一样，在客户端与服务器端传输的TCP报文中，双方的确认号Ack和序号Seq的值，都是在彼此Ack和Seq值的基础上进行计算的，这样做保证了TCP报文传输的连贯性，一旦出现某一方发出的TCP报文丢失，便无法继续"挥手"，以此确保了"四次挥手"的顺利完成。

<img src="https://s2.loli.net/2022/05/22/y5PlJOWBf8tV9dE.png" alt="fourwavehands.png" style="zoom:80%;" />

### HTTPS

在上述介绍`HTTP`中，了解到`HTTP`传递信息是以明文的形式发送内容，这并不安全。而`HTTPS`出现正是为了解决`HTTP`不安全的特性

`HTTPS = HTTP + SSL/TLS`，通过 `SSL`证书来验证服务器的身份，并为浏览器和服务器之间的通信进行加密

`SSL` 协议位于` TCP/IP` 协议与各种应用层协议之间, 浏览器和服务器在使用 `SSL` 建立连接时需要选择一组恰当的加密算法来实现安全通信

### HTTPS握手和数据传输

#### 内容加密

中间人随意截获, 如果在通信链路出现了一个Hacker，由于通信内容都是明文可见，所以Hacker可以嗅探看到这些内容，也可以篡改这些内容

- 对称加密

  既然明文有问题，那就需要对明文进行加密处理，让中间人看不懂内容，于是乎要对原来的内容变成一段看不懂的内容，称为加密，反之则是解密。把操作数A作为明文，操作数B作为密钥，结果C作为密文。可以看到加密解密运用同一个密钥B，把这种加解密都用同一个密钥的方式叫做对称加密

  但是这种方式对称加密秘钥也会被拦截，也不够安全，进而还是存在被中间人攻击风险

- 非对称密钥加密：
  - 使用第三方机构颁发的证书加密公钥(根据服务器地址等多个信息生成，无法被第三方伪造), 浏览器收到后使用证书机构颁发的公钥进行解密
  - 解密结果与用证书生成的规则再生成一个签名对比一致就是真证书

#### 基于内容加密的HTTPS传输过程

- 客户端发起一个加密网络（https）请求，建立SSL连接
- 服务端将CA证书(内包含公钥)传送一份给客户端
- 客户端开始验证证书的合法性，证书包含了发放日期、到期时间、颁发机构等信息，利用证书上的数字水印验证是否合法，如果不合法，会提出警告信息，如果证书合法，说明是可信赖的机构生产的
- 客户端的浏览器根据双方同意的安全等级，建立会话密钥，然后利用网站的公钥将会话密钥加密，并传送给服务器
- 服务器利用自己的私钥解密出会话密钥
- 服务器利用会话密钥加密与客户端之间的通信

![HTTPSSSL.png](https://s2.loli.net/2022/05/22/6NpC7RU8QtESkDV.png)

### 参考

[详解TCP连接的三次握手与四次挥手](https://www.cnblogs.com/AhuntSun-blog/p/12037852.html)

[一次安全可靠的通信——HTTPS原理](https://developers.weixin.qq.com/community/develop/article/doc/000046a5fdc7802a15f7508b556413)

